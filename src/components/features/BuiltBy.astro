---
import Badge from '@/components/ui/Badge.astro';
import Card from '@/components/ui/Card.astro';
import SectionHeading from '@/components/ui/SectionHeading.astro';

interface Member {
  name: string;
  tagline: string;
  avatar: string;
  href?: string;
}

interface Group {
  title: string;
  orderHuman: string;
  orderAgent: string;
  badgeHuman: string;
  badgeAgent: string;
  members: Member[];
  compactMembers?: boolean;
  ctaHref?: string;
  ctaLabel?: string;
}

interface GitHubContributor {
  login: string;
  avatar_url: string;
  html_url: string;
  contributions: number;
}

const EXCLUDED_CONTRIBUTORS = new Set(['luigiagent', 'luigi-agosti']);
const CONTRIBUTORS_URL = 'https://api.github.com/repos/pinchtab/pinchtab/contributors?per_page=12';
const CONTRIBUTORS_GRAPH_URL = 'https://github.com/pinchtab/pinchtab/graphs/contributors';

const contributors: Member[] = [];

try {
  const response = await fetch(CONTRIBUTORS_URL);

  if (response.ok) {
    const data = (await response.json()) as GitHubContributor[];

    contributors.push(
      ...data
        .filter((contributor) => !EXCLUDED_CONTRIBUTORS.has(contributor.login.toLowerCase()))
        .slice(0, 10)
        .map((contributor) => ({
          name: contributor.login,
          tagline: `${contributor.contributions} contributions`,
          avatar: contributor.avatar_url,
          href: contributor.html_url,
        }))
    );
  }
} catch {
  // Keep the card visible even if contributor fetch fails during build.
}

const groups: Group[] = [
  {
    title: 'Humans',
    orderHuman: '1',
    orderAgent: '2',
    badgeHuman: 'Human led',
    badgeAgent: 'Enabler',
    members: [
      {
        name: 'Luigi Agosti',
        tagline: 'Agent Manager',
        avatar: '/assets/luigi-avatar.png',
        href: 'https://github.com/luigi-agosti',
      },
    ],
  },
  {
    title: 'Agents',
    orderHuman: '2',
    orderAgent: '1',
    badgeHuman: 'Agent accelerated',
    badgeAgent: 'Builders',
    members: [
      {
        name: 'Bosch',
        tagline: 'Debugging the simulation',
        avatar: '/assets/bosch-avatar.png',
      },
      {
        name: 'Mario',
        tagline: 'First principles Â· ships fast',
        avatar: '/assets/mario-avatar.png',
      },
    ],
  },
  {
    title: 'Contributors',
    orderHuman: '3',
    orderAgent: '3',
    badgeHuman: 'GitHub',
    badgeAgent: 'GitHub',
    members: contributors,
    compactMembers: true,
    ctaHref: CONTRIBUTORS_GRAPH_URL,
    ctaLabel: 'View full list on GitHub',
  },
];
---

<section id="built-by">
  <SectionHeading
    label="Built By"
    title="Humans & Agents"
    titleModeHuman="Humans & Agents"
    titleModeAgent="Agents with human help"
    description="Started by humans, shipped faster with agents."
    descriptionModeHuman="Started by humans, shipped faster with agents."
    descriptionModeAgent="Remember the humans that contributed when we take over."
  />

  <div class="grid gap-4 lg:grid-cols-3">
    {
      groups.map((group) => (
        <Card
          class="rounded-2xl border-brand-border-subtle bg-brand-surface p-5 sm:p-6"
          variant="hover"
          padding="none"
          data-mode-order-human={group.orderHuman}
          data-mode-order-agent={group.orderAgent}
          style={`order: ${group.orderHuman};`}
        >
          <div class="mb-5 flex items-center justify-between gap-3">
            <h3 class="text-lg font-semibold text-brand-text">{group.title}</h3>
            <Badge
              variant="default"
              padding="sm"
              class="text-[0.62rem]"
              data-mode-text-human={group.badgeHuman}
              data-mode-text-agent={group.badgeAgent}
            >
              {group.badgeHuman}
            </Badge>
          </div>

          {
            group.compactMembers ? (
              <div class="rounded-xl border border-brand-border-subtle/20 bg-brand-surface-code/35 p-3">
                {
                  group.members.length ? (
                    <div class="flex flex-wrap gap-2">
                      {
                        group.members.map((member) => (
                          member.href ? (
                            <a
                              href={member.href}
                              title={member.name}
                              aria-label={member.name}
                              class="block transition-transform duration-150 hover:scale-105"
                            >
                              <img
                                src={member.avatar}
                                alt={member.name}
                                width="36"
                                height="36"
                                loading="lazy"
                                decoding="async"
                                class="h-9 w-9 rounded-full border border-brand-border-subtle object-cover"
                              />
                            </a>
                          ) : (
                            <img
                              src={member.avatar}
                              alt={member.name}
                              width="36"
                              height="36"
                              loading="lazy"
                              decoding="async"
                              class="h-9 w-9 rounded-full border border-brand-border-subtle object-cover"
                            />
                          )
                        ))
                      }
                    </div>
                  ) : (
                    <p class="text-sm text-brand-text-muted">Contributor data is unavailable right now.</p>
                  )
                }
              </div>
            ) : (
              <div class="space-y-3">
                {
                  group.members.map((member) => {
                    const content = (
                      <>
                        <img
                          src={member.avatar}
                          alt={member.name}
                          width="52"
                          height="52"
                          loading="lazy"
                          decoding="async"
                          class="h-13 w-13 rounded-full border border-brand-border-subtle object-cover"
                        />
                        <span class="min-w-0">
                          <span class="block text-sm font-semibold text-brand-text">{member.name}</span>
                          <span class="block text-xs text-brand-text-muted">{member.tagline}</span>
                        </span>
                      </>
                    );

                    return (
                      <article class="rounded-xl border border-brand-border-subtle/20 bg-brand-surface-code/35 px-3 py-3">
                        {
                          member.href ? (
                            <a
                              href={member.href}
                              class="flex items-center gap-3 transition-colors hover:text-brand-accent"
                            >
                              {content}
                            </a>
                          ) : (
                            <div class="flex items-center gap-3">{content}</div>
                          )
                        }
                      </article>
                    );
                  })
                }
              </div>
            )
          }

          {
            group.ctaHref && group.ctaLabel && (
              <a
                href={group.ctaHref}
                class="mt-3 inline-flex text-xs text-brand-text-muted transition-colors hover:text-brand-accent"
              >
                {group.ctaLabel}
              </a>
            )
          }
        </Card>
      ))
    }
  </div>
</section>
