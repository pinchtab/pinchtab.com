---
import { cn } from '@/lib/utils';

export interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<button
  class={cn(
    'human-agent-toggle fixed top-6 right-6 z-50 w-56 h-12 rounded-2xl',
    'bg-slate-800 transition-colors duration-200 cursor-pointer',
    'flex items-center px-1.5 py-1 gap-0',
    'shadow-sm shadow-black/40',
    'hover:shadow-md focus-visible:ring-2 focus-visible:ring-yellow-400/40 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950',
    'active:scale-98 select-none',
    className
  )}
  style="box-shadow: inset 0 1px 3px rgba(0,0,0,0.5), 0 2px 8px rgba(0,0,0,0.4);"
  role="switch"
  aria-checked="true"
  aria-label="Human or Agent mode toggle"
>
  <!-- Sliding Knob -->
  <div
    class="toggle-knob absolute w-10 h-10 rounded-xl bg-white transition-all duration-200 flex items-center justify-center"
    style="transform: translateX(0); box-shadow: 0 2px 8px rgba(0,0,0,0.3), inset 0 1px 2px rgba(255,255,255,0.5); left: 6px; top: 6px;"
  >
    <img
      src="/mode-human.png"
      alt="Human"
      class="toggle-icon w-5 h-5 object-contain transition-opacity duration-100"
      data-icon="human"
      style="opacity: 1;"
    />
    <img
      src="/mode-robot.png"
      alt="Agent"
      class="toggle-icon w-5 h-5 object-contain transition-opacity duration-100 absolute"
      data-icon="agent"
      style="opacity: 0;"
    />
  </div>

  <!-- Labels Container -->
  <div class="absolute inset-0 flex items-center px-4 pointer-events-none w-full">
    <!-- Human Label -->
    <span
      class="toggle-label w-1/2 text-left text-xs font-medium tracking-normal transition-opacity duration-200 text-slate-400"
      data-label="human"
      style="opacity: 1;"
    >
      HUMAN
    </span>

    <!-- Agent Label -->
    <span
      class="toggle-label w-1/2 text-right text-xs font-medium tracking-normal transition-opacity duration-200 text-slate-400"
      data-label="agent"
      style="opacity: 0;"
    >
      AGENT
    </span>
  </div>
</button>

<script is:inline>
  function initToggle() {
    const toggle = document.querySelector('.human-agent-toggle');
    if (!toggle) return;

    const stored = localStorage.getItem('pinchtab-mode') || 'human';
    updateToggleState(stored);

    toggle.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleMode();
    });
  }

  window.toggleMode = function() {
    const stored = localStorage.getItem('pinchtab-mode') || 'human';
    const newMode = stored === 'human' ? 'agent' : 'human';
    
    localStorage.setItem('pinchtab-mode', newMode);
    updateToggleState(newMode);
    document.dispatchEvent(new CustomEvent('modechange', { detail: { mode: newMode } }));
  };

  window.updateToggleState = function(mode) {
    const toggle = document.querySelector('.human-agent-toggle');
    const knob = document.querySelector('.toggle-knob');
    const humanIcon = document.querySelector('img[data-icon="human"]');
    const agentIcon = document.querySelector('img[data-icon="agent"]');
    const humanLabel = document.querySelector('span[data-label="human"]');
    const agentLabel = document.querySelector('span[data-label="agent"]');

    if (mode === 'human') {
      // HUMAN STATE
      toggle.setAttribute('aria-checked', 'true');
      toggle.style.backgroundColor = '#1e293b'; // slate-800
      
      knob.style.transform = 'translateX(0)';
      knob.style.backgroundColor = '#ffffff';
      
      humanIcon.style.opacity = '1';
      agentIcon.style.opacity = '0';
      
      humanLabel.style.opacity = '1';
      agentLabel.style.opacity = '0';
    } else {
      // AGENT STATE
      toggle.setAttribute('aria-checked', 'false');
      toggle.style.backgroundColor = '#eab308'; // yellow-400
      
      knob.style.transform = 'translateX(204px)';
      knob.style.backgroundColor = '#0f172a'; // slate-900
      
      humanIcon.style.opacity = '0';
      agentIcon.style.opacity = '1';
      
      humanLabel.style.opacity = '0';
      agentLabel.style.opacity = '1';
    }
  };

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initToggle);
  } else {
    initToggle();
  }
</script>
