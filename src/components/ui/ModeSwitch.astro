---
import { cn } from '@/lib/utils';

export interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<div class={cn(
  'fixed top-4 right-4 sm:top-6 sm:right-6 z-120',
  className
)}>
  <button
    type="button"
    class={cn(
      'group relative h-10 w-44 sm:h-11 sm:w-48 rounded-full border transition-all duration-300',
      'bg-[linear-gradient(120deg,rgba(24,27,38,0.96),rgba(17,20,30,0.98))]',
      'border-[rgb(var(--switch-track-border-rgb)/0.58)]',
      'shadow-[0_14px_30px_rgba(0,0,0,0.34)]',
      'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-accent/50',
      'focus-visible:ring-offset-2 focus-visible:ring-offset-brand-bg',
      'active:scale-[0.99] select-none'
    )}
    data-mode-switch
    role="switch"
    aria-checked="false"
    aria-label="Switch between human and agent mode"
  >
    <span
      class="pointer-events-none absolute inset-0.5 rounded-full border bg-[rgb(var(--switch-track-inner-rgb)/0.74)] border-[rgb(var(--switch-track-inner-border-rgb)/0.2)]"
      aria-hidden="true"
    ></span>

    <span
      class={cn(
        'absolute left-1 top-1 z-20 h-[calc(100%-8px)] w-[calc(50%-6px)] rounded-2xl border',
        'bg-[rgb(var(--switch-thumb-rgb)/1)]',
        'border-[rgb(var(--switch-thumb-border-rgb)/0.9)]',
        'shadow-[0_10px_20px_rgba(0,0,0,0.34),inset_0_1px_1px_rgba(255,255,255,0.35)]',
        'transition-all duration-300 ease-snappy will-change-transform'
      )}
      data-mode-thumb
      aria-hidden="true"
    >
      <span class="sr-only">Active mode indicator</span>
    </span>

    <span
      class={cn(
        'relative z-10 grid h-full w-full grid-cols-2 items-center',
        'px-2 text-[0.68rem] sm:text-[0.74rem] font-bold uppercase tracking-[0.08em]'
      )}
      aria-hidden="true"
    >
      <span class="text-center transition-all duration-300 text-[rgb(var(--switch-label-active-rgb)/1)]" data-mode-label-human>Humans</span>
      <span class="text-center transition-all duration-300 text-[rgb(var(--switch-label-active-rgb)/1)]" data-mode-label-agent>Agents</span>
    </span>
  </button>
</div>

<script is:inline>
  (() => {
    const STORAGE_KEY = 'pinchtab-mode';
    const SITE_MODE_ATTR = 'data-site-mode';
    const HUMAN = 'human';
    const AGENT = 'agent';
    const LEGACY_AGENT = 'agents';

    const toggles = Array.from(document.querySelectorAll('[data-mode-switch]'));
    if (!toggles.length) return;

    const normalizeMode = (value) => value === AGENT || value === LEGACY_AGENT ? AGENT : HUMAN;
    const setDocumentMode = (mode) => document.documentElement.setAttribute(SITE_MODE_ATTR, mode);
    const readStoredMode = () => {
      try {
        return localStorage.getItem(STORAGE_KEY);
      } catch {
        return null;
      }
    };
    const writeStoredMode = (mode) => {
      try {
        localStorage.setItem(STORAGE_KEY, mode);
      } catch {
        // no-op when storage is unavailable
      }
    };

    const applyState = (toggle, mode) => {
      const isAgent = mode === AGENT;

      const thumb = toggle.querySelector('[data-mode-thumb]');
      const humanLabel = toggle.querySelector('[data-mode-label-human]');
      const agentLabel = toggle.querySelector('[data-mode-label-agent]');
      if (!thumb || !humanLabel || !agentLabel) return;

      toggle.setAttribute('aria-checked', String(isAgent));
      toggle.dataset.mode = mode;

      const travelX = Math.max(0, toggle.clientWidth - thumb.offsetWidth - 8);
      thumb.style.transform = isAgent ? `translateX(${travelX}px)` : 'translateX(0px)';

      humanLabel.style.color = isAgent
        ? 'rgb(var(--switch-label-human-inactive-rgb) / 0.95)'
        : 'rgb(var(--switch-label-active-rgb) / 1)';
      agentLabel.style.color = isAgent
        ? 'rgb(var(--switch-label-active-rgb) / 1)'
        : 'rgb(var(--switch-label-agent-inactive-rgb) / 0.95)';
      humanLabel.style.opacity = '1';
      agentLabel.style.opacity = '1';
    };

    const applyAll = (mode, dispatch = false) => {
      const normalizedMode = normalizeMode(mode);
      writeStoredMode(normalizedMode);
      setDocumentMode(normalizedMode);
      toggles.forEach((toggle) => applyState(toggle, normalizedMode));

      if (dispatch) {
        document.dispatchEvent(new CustomEvent('modechange', { detail: { mode: normalizedMode } }));
      }
    };

    const initialMode = normalizeMode(readStoredMode());
    applyAll(initialMode, false);

    toggles.forEach((toggle) => {
      toggle.addEventListener('click', () => {
        const currentMode = normalizeMode(readStoredMode() || toggle.dataset.mode);
        const nextMode = currentMode === HUMAN ? AGENT : HUMAN;
        applyAll(nextMode, true);
      });

      toggle.addEventListener('keydown', (event) => {
        if (event.key === 'ArrowLeft') {
          event.preventDefault();
          applyAll(HUMAN, true);
        }

        if (event.key === 'ArrowRight') {
          event.preventDefault();
          applyAll(AGENT, true);
        }
      });
    });

    window.addEventListener('resize', () => {
      const activeMode = normalizeMode(readStoredMode());
      toggles.forEach((toggle) => applyState(toggle, activeMode));
    });
  })();
</script>
